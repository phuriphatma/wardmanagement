<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ward & Bed Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    * { box-sizing:border-box }
    body,html { margin:0; padding:0; height:100%; font-family:sans-serif; overflow:hidden }
    #container { display:flex; height:100%; position:relative }

    /* SIDEBAR */
    #sidebar {
      width:250px;            /* default width */
      min-width:100px; max-width:80%;
      border-right:1px solid #ccc;
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    #sidebarHeader {
      display:flex;
      flex-direction:column;
      background:#fafafa;
      border-bottom:1px solid #ddd;
    }
    #sidebarHeader button {
      width:100%;
      padding:12px;
      font-size:18px;
      background:#fff;
      border:none;
      border-bottom:1px solid #ddd;
      cursor:pointer;
    }
    #sidebarHeader button#addWardBtn {
      border-bottom:none;
    }

    #wardListContainer { flex:1; overflow-y:auto; padding:8px }
    #wardList { list-style:none; margin:0; padding:0 }
    #wardList li {
      padding:6px; margin:4px 0; border-radius:4px;
      cursor:pointer; user-select:none; border:1px solid transparent;
    }
    #wardList li.selected { background:#def }
    #wardList li.over { border:1px dashed #000 }
    .controls { margin-top:10px }

    /* RESIZER */
    #resizer {
      width:5px; cursor:col-resize;
      background:rgba(0,0,0,0.05);
    }

    /* MAIN */
    #main {
      flex:1; padding:10px; overflow-y:auto;
    }
    #bedList { cursor:default; }
    #bedList .bed-item {
      display:flex; flex-direction:column;
      gap:6px; border-bottom:1px solid #eee; padding:8px 0;
      cursor:grab; /* Indicates it is draggable */
    }
    #bedList .bed-item.over {
      border-top: 3px solid #007bff; /* Highlight drop target */
      padding-top: 5px; /* Adjust padding for border */
    }
    /* Hide default border when dragging over a target */
    #bedList .bed-item.over:last-child {
        border-bottom: 1px solid #eee;
    }


    #bedList textarea {
      width:100%; font-size:14px;
      padding:6px; border:1px solid #ccc; border-radius:4px;
      resize: vertical; /* Allow manual vertical resize */
      min-height: 28px; /* Standard input height for single line */
    }
    /* Style for the Bed Name Textarea (Title) */
    #bedList .bed-name {
        font-weight: bold;
        font-size: 16px;
        padding-top: 3px;
        border: 1px solid #ccc;
    }


    #bedList button {
      align-self:flex-start;
      padding:6px 12px; border:1px solid #c00;
      background:#fee; color:#900; border-radius:4px;
      cursor:pointer;
    }

    /* EXPAND BUTTON */
    #expandSidebarBtn {
      position:absolute; left:0; top:50px;
      width:24px; height:32px;
      padding:0; line-height:32px; text-align:center;
      border:1px solid #ccc; background:#fff;
      border-radius:0 4px 4px 0;
      cursor:pointer; display:none; z-index:1000;
      font-size: 18px; /* Matching the sidebar button size */
    }

    /* COLLAPSED STATE */
    body.collapsed #sidebar,
    body.collapsed #resizer {
      display:none;
    }
    body.collapsed #expandSidebarBtn {
      display:block;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div id="sidebarHeader">
        <button id="toggleSidebarBtn">&#9776;</button>
        <button id="addWardBtn">+ Add Ward</button>
      </div>
      <div id="wardListContainer">
        <ul id="wardList"></ul>
        <div class="controls">
          <button id="exportBtn">Export Data</button>
          <button id="importBtn">Import Data</button>
          <input type="file" id="fileInput" style="display:none">
        </div>
      </div>
    </div>
    <div id="resizer"></div>
    <div id="main">
      <h2 id="wardTitle">Select a ward</h2>
      <button id="addBedBtn" disabled>+ Add Bed</button>
      <div id="bedList"></div>
    </div>
    <button id="expandSidebarBtn">&#9776;</button>
  </div>

  <script>
  (function(){
    const STORAGE_KEY = 'wardManagerData';
    const WIDTH_KEY   = 'wardSidebarWidth';
    let data           = { wards: [] };
    let selectedWardId = null, dragSrcId = null, bedDragSrcId = null; 

    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function loadData(){
      const js = localStorage.getItem(STORAGE_KEY);
      if(js) try{ data = JSON.parse(js) }catch{}
    }
    function uuid(){ return 'x'+Date.now()+Math.floor(Math.random()*1000) }

    // Helper function for textareas to auto-expand vertically
    function autoGrowTextarea(element) {
        element.style.height = 'auto'; // Reset height
        // Calculate the height needed (scroll height) and set CSS padding/border appropriately
        // We use min-height defined in CSS to handle the initial small size.
        element.style.height = element.scrollHeight + 'px';
    }


    function renderWards(){
      const ul = document.getElementById('wardList'); ul.innerHTML = '';
      data.wards.forEach(w=>{
        const li = document.createElement('li');
        li.textContent = w.name +' ('+ w.beds.length +' beds)';
        if(w.id===selectedWardId) li.classList.add('selected');
        li.onclick = ()=>{ selectedWardId = w.id; renderWards(); renderBeds(); };
        li.draggable = true;
        li.addEventListener('dragstart', (e)=> {
            dragSrcId = w.id;
            e.dataTransfer.effectAllowed = 'move';
        });
        li.addEventListener('dragover', e=>{ e.preventDefault(); li.classList.add('over') });
        li.addEventListener('dragleave', ()=> li.classList.remove('over'));
        li.addEventListener('drop', e=>{
          e.stopPropagation(); li.classList.remove('over');
          if(!dragSrcId||dragSrcId===w.id) return;
          const from = data.wards.findIndex(x=>x.id===dragSrcId);
          const to   = data.wards.findIndex(x=>x.id===w.id);
          const [m]  = data.wards.splice(from,1);
          data.wards.splice(to,0,m);
          saveData(); renderWards();
        });
        ul.appendChild(li);
      });
    }

    function renderBeds(){
      const bedList = document.getElementById('bedList');
      const title   = document.getElementById('wardTitle');
      const addBtn  = document.getElementById('addBedBtn');
      bedList.innerHTML = '';

      const ward = data.wards.find(w=>w.id===selectedWardId);
      if(!ward){
        title.textContent = 'Select a ward';
        addBtn.disabled = true;
        return;
      }
      title.textContent = 'Ward: '+ward.name;
      addBtn.disabled = false;

      ward.beds.forEach((b,i)=>{
        const div = document.createElement('div');
        div.className = 'bed-item';
        div.draggable = true;
        div.setAttribute('data-bed-id', b.id);

        // --- Drag-and-Drop for Beds ---
        div.addEventListener('dragstart', e => {
            bedDragSrcId = b.id;
            e.dataTransfer.effectAllowed = 'move';
            // Set the drop zone to be the entire row
            setTimeout(() => div.style.opacity = 0.5, 0); 
        });
        div.addEventListener('dragend', () => {
            div.style.opacity = 1;
        });
        div.addEventListener('dragover', e => { 
            e.preventDefault(); 
            // Avoid dragging onto itself
            if(b.id !== bedDragSrcId) div.classList.add('over');
        });
        div.addEventListener('dragleave', () => { 
            div.classList.remove('over'); 
        });
        div.addEventListener('drop', e => {
            e.stopPropagation();
            div.classList.remove('over');
            if (!bedDragSrcId || bedDragSrcId === b.id) return;

            const beds = ward.beds;
            const from = beds.findIndex(x => x.id === bedDragSrcId);
            const to   = beds.findIndex(x => x.id === b.id);
            
            // Move item
            const [movedBed] = beds.splice(from, 1);
            beds.splice(to, 0, movedBed);

            saveData();
            renderBeds();
        });

        // Bed Name Textarea (Now allowing multi-line expansion)
        const nameTa = document.createElement('textarea');
        nameTa.className = 'bed-name';
        nameTa.rows = 1; 
        nameTa.placeholder = 'Bed Name (e.g., Room 1 Bed A)'; 
        nameTa.value = b.name;
        
        // Initial auto-grow calculation
        nameTa.onfocus = () => autoGrowTextarea(nameTa);
        nameTa.onblur = () => autoGrowTextarea(nameTa);

        nameTa.oninput = ()=>{
          b.name = nameTa.value; 
          saveData(); 
          renderWards();
          autoGrowTextarea(nameTa);
        };

        const detTa = document.createElement('textarea');
        detTa.rows = 2; 
        detTa.placeholder = 'Details (Patient info, Notes...)'; 
        detTa.value = b.details;

        // Initial auto-grow calculation
        detTa.onfocus = () => autoGrowTextarea(detTa);
        detTa.onblur = () => autoGrowTextarea(detTa);

        detTa.oninput = ()=>{
          b.details = detTa.value; 
          saveData();
          autoGrowTextarea(detTa); 
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = ()=>{
          if(!confirm('Delete this bed?')) return;
          ward.beds.splice(i,1);
          saveData(); renderBeds(); renderWards();
        };

        div.appendChild(nameTa);
        div.appendChild(detTa);
        div.appendChild(delBtn);
        bedList.appendChild(div);
        
        // Ensure textareas are sized correctly on load
        autoGrowTextarea(nameTa);
        autoGrowTextarea(detTa);
      });
    }

    document.getElementById('addWardBtn').onclick = ()=>{
      const name = prompt('Ward name'); if(!name) return;
      data.wards.push({ id:uuid(), name, beds:[] });
      saveData(); renderWards();
    };
    document.getElementById('addBedBtn').onclick = ()=>{
      const ward = data.wards.find(w=>w.id===selectedWardId);
      if(!ward) return;
      ward.beds.push({ id:uuid(), name:'New Bed', details:'' });
      saveData(); renderBeds(); renderWards();
      // Focus on the new bed's name field
      setTimeout(()=>{
        const textareas = document.querySelectorAll('#bedList .bed-item textarea.bed-name');
        if(textareas.length) textareas[textareas.length-1].focus();
      },0);
    };

    document.getElementById('exportBtn').onclick = ()=>{
      const pass = prompt('Export password'); if(pass==null) return;
      const enc  = CryptoJS.AES.encrypt(JSON.stringify(data),pass).toString();
      const blob = new Blob([enc],{type:'text/plain'}), url=URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='ward-backup.txt'; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('importBtn').onclick = ()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = e=>{
      const f=e.target.files[0](undefined); if(!f)return;
      const r=new FileReader();
      r.onload=ev=>{
        const pass=prompt('Import password'); if(pass==null)return;
        try {
          const dec=CryptoJS.AES.decrypt(ev.target.result,pass)
                         .toString(CryptoJS.enc.Utf8);
          const obj=JSON.parse(dec);
          if(!confirm('Overwrite current data?'))return;
          data=obj; saveData();
          selectedWardId=null; renderWards(); renderBeds(); alert('Import OK');
        } catch(_) {
          alert('Bad password or corrupt file');
        }
      };
      r.readAsText(f); e.target.value='';
    };

    document.getElementById('toggleSidebarBtn').onclick = ()=>{
      document.body.classList.add('collapsed');
    };
    document.getElementById('expandSidebarBtn').onclick = ()=>{
      document.body.classList.remove('collapsed');
    };

    // Resizer + persist width
    const sidebar = document.getElementById('sidebar');
    const resizer = document.getElementById('resizer');
    let isResizing = false;
    const savedW = localStorage.getItem(WIDTH_KEY);
    if(savedW) sidebar.style.width = savedW+'px';

    function saveWidth(x){
      localStorage.setItem(WIDTH_KEY,x);
      sidebar.style.width = x+'px';
    }
    function onMouseMove(e){
      if(!isResizing) return;
      let x=e.clientX, min=100, max=window.innerWidth-100;
      if(x<min)x=min; if(x>max)x=max;
      saveWidth(x);
    }
    function onMouseUp(){
      if(!isResizing) return;
      isResizing=false;
      document.removeEventListener('mousemove',onMouseMove);
      document.removeEventListener('mouseup',onMouseUp);
    }
    resizer.addEventListener('mousedown',e=>{
      isResizing=true;
      document.addEventListener('mousemove',onMouseMove);
      document.addEventListener('mouseup',onMouseUp);
    });
    resizer.addEventListener('touchstart',e=>{isResizing=true;},{passive:false});
    document.addEventListener('touchmove',e=>{
      if(!isResizing) return;
      let x=e.touches[0](undefined).clientX, min=100, max=window.innerWidth-100;
      if(x<min)x=min; if(x>max)x=max;
      saveWidth(x);
    },{passive:false});
    document.addEventListener('touchend',onMouseUp);

    loadData(); renderWards(); renderBeds();
  })();
  </script>
</body>
</html>
```
