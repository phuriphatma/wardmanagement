<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ward & Bed Manager + Patient Profile</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body,html{margin:0;padding:0;height:100%;overflow:hidden}
#container{display:flex;height:100%;position:relative}

/* Sidebar */
#sidebar{width:250px;min-width:100px;max-width:80%;border-right:1px solid #ccc;
display:flex;flex-direction:column;overflow:hidden}
#sidebarHeader{display:flex;flex-direction:column;background:#fafafa;border-bottom:1px solid #ddd}
#sidebarHeader button{width:100%;padding:12px;font-size:18px;background:#fff;border:none;
border-bottom:1px solid #ddd;cursor:pointer}
#sidebarHeader button#addWardBtn{border-bottom:none}
#wardListContainer{flex:1;overflow-y:auto;padding:8px}
#wardList{list-style:none;margin:0;padding:0}
#wardList li{padding:6px;margin:4px 0;border-radius:4px;cursor:pointer;user-select:none;border:1px solid transparent}
#wardList li.selected{background:#def}
#wardList li.over{border:1px dashed #000}
.controls{margin-top:10px}

/* Resizer */
#resizer{width:5px;cursor:col-resize;background:rgba(0,0,0,0.05)}

/* Main area */
#main{flex:1;display:flex;flex-direction:row;overflow:hidden}
#bedContainer{flex:1;padding:10px;overflow-y:auto;scroll-behavior:smooth;border-right:1px solid #eee}
#bedList .bed-item{display:flex;flex-direction:column;gap:6px;border-bottom:1px solid #eee;padding:8px 0;cursor:grab}
#bedList .bed-item.over{border-top:3px solid #007bff;padding-top:5px}
#bedList textarea{width:100%;font-size:14px;padding:6px;border:1px solid #ccc;border-radius:4px;
resize:vertical;min-height:28px;overflow:hidden}
#bedList .bed-name{font-weight:bold;font-size:16px}
#bedList button{align-self:flex-start;padding:6px 12px;border:1px solid #c00;
background:#fee;color:#900;border-radius:4px;cursor:pointer}

/* Profile panel */
#profilePanel{width:360px;max-width:100%;padding:16px;overflow-y:auto;display:none;background:#f9fafb}
#profilePanel.active{display:block}
#profilePanel h2{margin-top:0}
#profilePanel label{display:block;margin:8px 0;font-weight:600}
#profilePanel input,#profilePanel textarea,#profilePanel select{
  width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:14px}
#profilePanel .row{display:flex;gap:8px;align-items:center}
#profilePanel .row label{flex:1}

/* Expand button */
#expandSidebarBtn{position:absolute;left:0;top:50px;width:24px;height:32px;
padding:0;line-height:32px;text-align:center;border:1px solid #ccc;background:#fff;
border-radius:0 4px 4px 0;cursor:pointer;display:none;z-index:1000;font-size:18px}
body.collapsed #sidebar,body.collapsed #resizer{display:none}
body.collapsed #expandSidebarBtn{display:block}
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <div id="sidebarHeader">
      <button id="toggleSidebarBtn">&#9776;</button>
      <button id="addWardBtn">+ Add Ward</button>
    </div>
    <div id="wardListContainer">
      <ul id="wardList"></ul>
      <div class="controls">
        <button id="exportBtn">Export Data</button>
        <button id="importBtn">Import Data</button>
        <input type="file" id="fileInput" style="display:none">
      </div>
    </div>
  </div>
  <div id="resizer"></div>
  <div id="main">
    <div id="bedContainer">
      <h2 id="wardTitle">Select a ward</h2>
      <button id="addBedBtn" disabled>+ Add Bed</button>
      <div id="bedList"></div>
    </div>
    <div id="profilePanel">
      <h2>Patient Profile</h2>
      <div class="row">
        <label>Bed/Room<input id="profileBed" placeholder="e.g., 6/1 รวม3"></label>
        <label>Name<input id="profileName" placeholder="e.g., อัครเดช"></label>
      </div>
      <label>Hashtags / Dx<textarea id="profileDx" rows="5" placeholder="CCA c HCV cirrhosis&#10;U/D HT"></textarea></label>
      <label>Notes<textarea id="profileNote" rows="6" placeholder="Progress note..."></textarea></label>
    </div>
  </div>
  <button id="expandSidebarBtn">&#9776;</button>
</div>

<script>
(function(){
const STORAGE_KEY='wardManagerData';
const WIDTH_KEY='wardSidebarWidth';
let data={wards:[]},selectedWardId=null,selectedBedId=null,dragSrcId=null,bedDragSrcId=null;

function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data))}
function loadData(){const js=localStorage.getItem(STORAGE_KEY);if(js)try{data=JSON.parse(js)}catch{}}
function uuid(){return 'x'+Date.now()+Math.floor(Math.random()*1000)}
function autoGrow(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}

function renderWards(){
  const ul=document.getElementById('wardList');ul.innerHTML='';
  data.wards.forEach(w=>{
    const li=document.createElement('li');
    li.textContent=w.name+' ('+w.beds.length+' beds)';
    if(w.id===selectedWardId)li.classList.add('selected');
    li.onclick=()=>{selectedWardId=w.id;selectedBedId=null;renderWards();renderBeds();hideProfile();};
    li.draggable=true;
    li.addEventListener('dragstart',e=>{dragSrcId=w.id;e.dataTransfer.effectAllowed='move';});
    li.addEventListener('dragover',e=>{e.preventDefault();li.classList.add('over')});
    li.addEventListener('dragleave',()=>li.classList.remove('over'));
    li.addEventListener('drop',e=>{
      e.stopPropagation();li.classList.remove('over');
      if(!dragSrcId||dragSrcId===w.id)return;
      const from=data.wards.findIndex(x=>x.id===dragSrcId);
      const to=data.wards.findIndex(x=>x.id===w.id);
      const [m]=data.wards.splice(from,1);data.wards.splice(to,0,m);
      saveData();renderWards();
    });
    ul.appendChild(li);
  });
}

function renderBeds(){
  const bedList=document.getElementById('bedList');
  const title=document.getElementById('wardTitle');
  const addBtn=document.getElementById('addBedBtn');
  bedList.innerHTML='';
  const ward=data.wards.find(w=>w.id===selectedWardId);
  if(!ward){title.textContent='Select a ward';addBtn.disabled=true;return;}
  title.textContent='Ward: '+ward.name;addBtn.disabled=false;
  ward.beds.forEach((b,i)=>{
    const div=document.createElement('div');
    div.className='bed-item';div.draggable=true;
    div.setAttribute('data-bed-id',b.id);
    div.addEventListener('click',()=>showProfile(b));
    div.addEventListener('dragstart',e=>{bedDragSrcId=b.id;e.dataTransfer.effectAllowed='move';setTimeout(()=>div.style.opacity=0.5,0);});
    div.addEventListener('dragend',()=>{div.style.opacity=1;});
    div.addEventListener('dragover',e=>{e.preventDefault();if(b.id!==bedDragSrcId)div.classList.add('over');});
    div.addEventListener('dragleave',()=>div.classList.remove('over'));
    div.addEventListener('drop',e=>{
      e.stopPropagation();div.classList.remove('over');
      if(!bedDragSrcId||bedDragSrcId===b.id)return;
      const beds=ward.beds;
      const from=beds.findIndex(x=>x.id===bedDragSrcId);
      const to=beds.findIndex(x=>x.id===b.id);
      const [moved]=beds.splice(from,1);
      beds.splice(to,0,moved);
      saveData();renderBeds();
    });

    const nameTa=document.createElement('textarea');
    nameTa.className='bed-name';
    nameTa.placeholder='Bed Name';nameTa.value=b.name||'';
    nameTa.oninput=()=>{b.name=nameTa.value;saveData();renderWards();autoGrow(nameTa);}
    const delBtn=document.createElement('button');
    delBtn.textContent='Delete';
    delBtn.onclick=()=>{if(!confirm('Delete this bed?'))return;
      ward.beds.splice(i,1);saveData();renderBeds();renderWards();};
    div.appendChild(nameTa);
    div.appendChild(delBtn);
    bedList.appendChild(div);
    setTimeout(()=>autoGrow(nameTa),0);
  });
}

function showProfile(b){
  selectedBedId=b.id;
  const panel=document.getElementById('profilePanel');
  panel.classList.add('active');
  document.getElementById('profileBed').value=b.name||'';
  const d=JSON.parse(b.details||'{}');
  document.getElementById('profileName').value=d.name||'';
  document.getElementById('profileDx').value=d.dx||'';
  document.getElementById('profileNote').value=d.note||'';
}

function hideProfile(){document.getElementById('profilePanel').classList.remove('active');}

['profileBed','profileName','profileDx','profileNote'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const ward=data.wards.find(w=>w.id===selectedWardId);
    if(!ward)return;
    const bed=ward.beds.find(x=>x.id===selectedBedId);
    if(!bed)return;
    const d={
      name:document.getElementById('profileName').value,
      dx:document.getElementById('profileDx').value,
      note:document.getElementById('profileNote').value
    };
    bed.name=document.getElementById('profileBed').value;
    bed.details=JSON.stringify(d);
    saveData();renderWards();renderBeds();
  });
});

document.getElementById('addWardBtn').onclick=()=>{
  const name=prompt('Ward name');if(!name)return;
  data.wards.push({id:uuid(),name,beds:[]});
  saveData();renderWards();
};
document.getElementById('addBedBtn').onclick=()=>{
  const w=data.wards.find(w=>w.id===selectedWardId);
  if(!w)return;
  w.beds.push({id:uuid(),name:'New Bed',details:'{}'});
  saveData();renderBeds();renderWards();
};
document.getElementById('exportBtn').onclick=()=>{
  const pass=prompt('Export password');if(pass==null)return;
  const enc=CryptoJS.AES.encrypt(JSON.stringify(data),pass).toString();
  const blob=new Blob([enc],{type:'text/plain'}),url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='ward-backup.txt';a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('importBtn').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const pass=prompt('Import password');if(pass==null)return;
    try{
      const dec=CryptoJS.AES.decrypt(ev.target.result,pass).toString(CryptoJS.enc.Utf8);
      const obj=JSON.parse(dec);
      if(!confirm('Overwrite current data?'))return;
      data=obj;saveData();selectedWardId=null;renderWards();renderBeds();alert('Import OK');
    }catch{alert('Bad password or corrupt file');}
  };
  r.readAsText(f);e.target.value='';
};

document.getElementById('toggleSidebarBtn').onclick=()=>document.body.classList.add('collapsed');
document.getElementById('expandSidebarBtn').onclick=()=>document.body.classList.remove('collapsed');

/* Swipe to hide/show sidebar */
let startX=null,startY=null;
document.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;startY=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  if(startX===null)return;
  const dx=e.changedTouches[0].clientX-startX,dy=e.changedTouches[0].clientY-startY;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx<-50)document.body.classList.add('collapsed');
    else if(dx>50)document.body.classList.remove('collapsed');
  }
  startX=null;startY=null;
},{passive:true});

/* Sidebar resizer */
const sidebar=document.getElementById('sidebar');
const resizer=document.getElementById('resizer');
let resizing=false;
const savedW=localStorage.getItem(WIDTH_KEY);if(savedW)sidebar.style.width=savedW+'px';
function saveWidth(x){localStorage.setItem(WIDTH_KEY,x);sidebar.style.width=x+'px';}
resizer.addEventListener('mousedown',()=>{resizing=true});
document.addEventListener('mousemove',e=>{
  if(!resizing)return;
  let x=e.clientX;if(x<100)x=100;if(x>window.innerWidth-100)x=window.innerWidth-100;
  saveWidth(x);
});
document.addEventListener('mouseup',()=>resizing=false);

loadData();renderWards();renderBeds();
})();
</script>
</body>
</html>
